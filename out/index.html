<html>
  <head>
    <style>
      a {
        text-decoration: none;
        color: black;
      }
      div.subject_block {
        border-style: solid;
        border-width: 1px;
        padding: 5px;
        margin-top: 10px;
      }
      .predicate {
        font-style: italic;
        color: grey;
      }
    </style>
    <script src="statements.json" charset="UTF-8"></script>
  </head>
  <body>
    <div id="root"></div>
    <script>
      class PredicateUL {
        constructor(page, subject, predicate) {
          this.wanted_statements = page.statements.filter(
            s => (s.subject == subject) & (s.predicate == predicate)
          );
          this.subject = subject;
          this.predicate = predicate;
        }
        render() {
          if (this.wanted_statements.length == 0) return "\n";
          var innerHTML = `\n\n<li><span class=predicate>${this.predicate}</span>\n<ul>\n\n`;
          this.wanted_statements.forEach(
            s =>
              (innerHTML += `<li title='${s.documentName}: ${s.text}'><a href='${s.link}' target='_new'>${s.object}</a></li>`)
          );
          innerHTML += "</ul></li>\n";
          return innerHTML;
        }
      }
      class HTMLANDFILTERSUBGROUP {
        constructor(page, subject, predicate) {
          this.subgroups = page.statements.filter(
            s => (s.subject == subject) & (s.predicate == predicate)
          );
          this.subject = subject;
          this.predicate = predicate;
          this.blocks = this.subgroups.map(
            s => new SubjectBlock(page, s.object)
          );
        }
        render() {
          if (this.subgroups.length == 0) return "\n";
          var innerHTML = `\n\n<li><span class=predicate>${this.predicate}</span>\n<ul>\n\n`;
          this.subgroups.forEach(
            (s, i) =>
              (innerHTML +=
                `<li><span title='${s.documentName}: ${s.text}'><a href='${s.link}' target='_new'>${s.object}</a></li>` +
                this.blocks[i].render()) + "</li>\n"
          );
          innerHTML += "</ul></li>\n";
          return innerHTML;
        }
      }

      class SubjectBlock {
        constructor(page, subject) {
          this.page = page;
          this.subject = subject;
          this.blocks = page.predicates.map(p => this.handlePredicate(p));
          this.nstatements = page.statements.filter(
            x =>
              x.subject == subject &&
              page.predicates.map(x => x[0]).indexOf(x.predicate) > -1
          ).length;
        }
        handlePredicate(p) {
          if (p[1] == "html_and_filter")
            return new PredicateUL(this.page, this.subject, p[0]);
          if (p[1] == "html_and_filter_subgroup")
            return new HTMLANDFILTERSUBGROUP(this.page, this.subject, p[0]);
        }
        render() {
          if (this.nstatements == 0) return "\n";
          var innerHTML = "<div class=subject_block><ul>\n";
          this.blocks.forEach(b => (innerHTML += b.render()));
          innerHTML += "</ul></div>\n";
          return innerHTML;
        }
      }

      var page = {
        title: "Conceptualisation",
        target_subject: "conceptualisation",
        statements: statements,
        predicates: [
          ["definition", "html_and_filter"],
          ["synonym", "html_and_filter"],
          ["description", "html_and_filter"],
          ["requires", "html_and_filter"],
          ["use", "html_and_filter"],
          ["when to use", "html_and_filter"],
          ["should be", "html_and_filter"],
          ["uses", "html_and_filter_subgroup"],
          ["can use", "html_and_filter_subgroup"],
          ["has subtask", "html_and_filter_subgroup"],
          ["has subclass", "html_and_filter_subgroup"],
          ["reference", "html_and_filter"],
          ["topic of", "html_and_filter"]
        ]
      };
      // TODO: identify and deal with leftover statements
      var root = new SubjectBlock(page, page.target_subject);
      document.getElementById("root").innerHTML = page.title + root.render();
    </script>
  </body>
</html>
